

<!DOCTYPE html>


<html lang="en" data-content_root="" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Step-53 &#8212; My sample book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=5b4479735964841361fd" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=5b4479735964841361fd" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=5b4479735964841361fd" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=5b4479735964841361fd" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=5b4479735964841361fd"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'step-53';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Step-49" href="step-49.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="My sample book - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="My sample book - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to your Jupyter Book
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="markdown.html">Markdown Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="markdown-notebooks.html">Notebooks with MyST Markdown</a></li>
<li class="toctree-l1"><a class="reference internal" href="step-49.html">Step-49</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Step-53</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fstep-53.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/step-53.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Step-53</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#python-initialization">Python initialization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#where-geometry-and-meshes-intersect">Where geometry and meshes intersect</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-example-case">The example case</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-commented-program">The commented program</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#describing-topography">Describing topography</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#describing-the-geometry">Describing the geometry</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-the-mesh">Creating the mesh</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="step-53">
<h1>Step-53<a class="headerlink" href="#step-53" title="Permalink to this heading">#</a></h1>
<p>This is a replica of <a class="reference external" href="https://www.dealii.org/current/doxygen/deal.II/step_53.html">step-53</a> C++ tutorial program. However, here we will use the deal.II Python interface to implement the functionality of the original tutorial.</p>
<p>Not all of the material is replicated since some parts of the original C++ tutorial are only relevant when using C++. Therefore, it is recommended that you first go through the original C++ tutorial to see all the details covered there.</p>
<p><em>This notebook is contributed by Alexander Grayver, 2020</em></p>
<section id="python-initialization">
<h2>Python initialization<a class="headerlink" href="#python-initialization" title="Permalink to this heading">#</a></h2>
<p>Provided the deal.II library was compiled with the python wrappers, we can import the module <strong>PyDealII</strong>. Note that it is only a shell and importing it will only allow you to call</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">help</span><span class="p">(</span><span class="n">PyDealII</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>PyDealII</strong> is composed of two libraries:</p>
<ul class="simple">
<li><p><strong>PyDealII.Debug</strong> which uses the debug version of <strong>deal.II</strong></p></li>
<li><p><strong>PyDealII.Release</strong> which uses the release version of <strong>deal.II</strong></p></li>
</ul>
<p>Let us import the release version of the library and give it the shortname <strong>dealii</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">PyDealII.Release</span> <span class="k">as</span> <span class="nn">dealii</span>
</pre></div>
</div>
</div>
</div>
<p>In addition, we will import a few widely used python packages</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="o">%</span><span class="k">matplotlib</span> inline
</pre></div>
</div>
</div>
</div>
</section>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">#</a></h2>
<p>Partial differential equations for realistic problems are often posed on
domains with complicated geometries. To provide just a few examples, consider
these cases:</p>
<ul class="simple">
<li><p>Among the two arguably most important industrial applications for the finite
element method, aerodynamics and more generally fluid dynamics is
one. Computer simulations today are used in the design of every airplane,
car, train and ship. The domain in which the partial differential equation
is posed is, in these cases, the air surrounding the plane with its wings,
flaps and engines; the air surrounding the car with its wheel, wheel wells,
mirrors and, in the case of race cars, all sorts of aerodynamic equipment;
the air surrounding the train with its wheels and gaps between cars. In the
case of ships, the domain is the water surrounding the ship with its rudders
and propellers.</p></li>
<li><p>The other of the two big applications of the finite element method is
structural engineering in which the domains are bridges, airplane nacelles
and wings, and other solid bodies of often complicated shapes.</p></li>
<li><p>Finite element modeling is also often used to describe the generation and
propagation of earthquake waves. In these cases, one needs to accurately
represent the geometry of faults in the Earth crust. Since faults intersect,
dip at angles, and are often not completely straight, domains are frequently
very complex.
One could cite many more examples of complicated geometries in which one wants
to pose and solve a partial differential equation. What this shows is that the
“real” world is much more complicated than what we have shown in almost all of
the tutorial programs preceding this one.</p></li>
</ul>
<p>This program is therefore devoted to showing how one deals with complex
geometries using a concrete application. In particular, what it shows is how
we make a mesh fit the domain we want to solve on. On the other hand, what the
program does not show is how to create a coarse for a domain. The process to
arrive at a coarse mesh is called “mesh generation” and there are a number of
high-quality programs that do this much better than we could ever
implement. However, deal.II does have the ability to read in meshes in many
formats generated by mesh generators and then make them fit a given shape,
either by deforming a mesh or refining it a number of times until it fits. The
deal.II Frequently Asked Questions page referenced from <a class="reference external" href="http://www.dealii.org/">http://www.dealii.org/</a>
provides resources to mesh generators.</p>
<section id="where-geometry-and-meshes-intersect">
<h3>Where geometry and meshes intersect<a class="headerlink" href="#where-geometry-and-meshes-intersect" title="Permalink to this heading">#</a></h3>
<p>Let us assume that you have a complex domain and that you already have a
coarse mesh that somehow represents the general features of the domain. Then
there are two situations in which it is necessary to describe to a deal.II
program the details of your geometry:</p>
<ul class="simple">
<li><p>Mesh refinement: Whenever a cell is refined, it is necessary to introduce
new vertices in the <a class="reference external" href="https://www.dealii.org/current/doxygen/deal.II/classTriangulation.html">Triangulation</a>.
In the simplest case, one assumes that
the objects that make up the <a class="reference external" href="https://www.dealii.org/current/doxygen/deal.II/classTriangulation.html">Triangulation</a> are straight line segments, a
bi-linear surface or a tri-linear volume. The next vertex is then simply put
into the middle of the old ones. However, for curved boundaries or if we
want to solve a PDE on a curved, lower-dimensional manifold embedded in a
higher-dimensional space, this is insufficient since it will not respect the
actual geometry. We will therefore have to tell <a class="reference external" href="https://www.dealii.org/current/doxygen/deal.II/classTriangulation.html">Triangulation</a> where to put
new points.</p></li>
<li><p>Integration: When using higher order finite element methods, it is often
necessary to compute integrals using curved approximations of the boundary,
i.e., describe each edge or face of cells as curves, instead of straight
line segments or bilinear patches. The same is, of course, true when
integrating boundary terms (e.g., inhomogeneous Neumann boundary
conditions). For the purpose of integration, the various <a class="reference external" href="https://www.dealii.org/current/doxygen/deal.II/classMapping.html">Mapping</a> classes
then provide the transformation from the reference cell to the actual cell.</p></li>
</ul>
<p>In both cases, we need a way to provide information about the geometry of the
domain at the level of an individual cell, its faces and edges. This is where
the Manifold class comes into play. Manifold is an abstract base class that
only defines an interface by which the <a class="reference external" href="https://www.dealii.org/current/doxygen/deal.II/classTriangulation.html">Triangulation</a> and <a class="reference external" href="https://www.dealii.org/current/doxygen/deal.II/classMapping.html">Mapping</a> classes can
query geometric information about the domain. Conceptually, <a class="reference external" href="https://www.dealii.org/current/doxygen/deal.II/classManifold.html">Manifold</a> sees the
world in a way not dissimilar to how the mathematical subdiscipline geometry
sees it: a domain is essentially just a collection of points that is somehow
equipped with the notion of a distance between points so that we can obtain a
point “in the middle” of some other points.</p>
<p>deal.II provides a number of classes that implement the interface provided by
<a class="reference external" href="https://www.dealii.org/current/doxygen/deal.II/classManifold.html">Manifold</a> for a variety of common geometries. On the other hand, in this
program we will consider only a very common and much simpler case, namely the
situation where (a part of) the domain we want to solve on can be described by
transforming a much simpler domain (we will call this the “reference domain”).
In the language of mathematics, this means
that the (part of the) domain is a <a
href="http://en.wikipedia.org/wiki/Chart_%28topology%29">chart</a>. Charts are
described by a smooth function that maps from the simpler domain to the chart
(the “push-forward” function) and its inverse (the “pull-back” function). If
the domain as a whole is not a chart (e.g., the surface of a sphere), then it
can often be described as a collection of charts (e.g., the northern
hemisphere and the southern hemisphere are each charts) and the domain can then
be describe by an <a
href="http://en.wikipedia.org/wiki/Atlas_%28topology%29">atlas</a>.</p>
<p>If a domain can be decomposed into an atlas, all we need to do is provide the
pull-back and push-forward functions for each of the charts. In deal.II, this
means providing a class derived from <a class="reference external" href="https://www.dealii.org/current/doxygen/deal.II/classChartManifold.html">ChartManifold</a>, and this is precisely what
we will do in this program.</p>
</section>
<section id="the-example-case">
<h3>The example case<a class="headerlink" href="#the-example-case" title="Permalink to this heading">#</a></h3>
<p>To illustrate how one describes geometries using charts in deal.II, we will consider a case that originates in an application of the <a class="reference external" href="https://aspect.geodynamics.org/">ASPECT</a> mantle convection code, using a data set provided by D. Sarah Stamps. In the concrete application, we were interested in describing flow in the Earth mantle under the <a class="reference external" href="http://en.wikipedia.org/wiki/East_African_rift">East African Rift</a>, a zone where two continental plates drift apart. Not to beat around the bush, the geometry we want to describe looks like this:
<img alt="Image" src="https://www.dealii.org/images/steps/developer/step-53.topo.png" /></p>
<p>In particular, though you cannot see this here, the top surface is not just colored by the elevation but is, in fact, deformed to follow the correct topography. While the actual application is not relevant here, the geometry is. The domain we are interested in is a part of the Earth that ranges from the surface to a depth of 500km, from 26 to 35 degrees East of the Greenwich meridian, and from 5 degrees North of the equator to 10 degrees South.</p>
<p>This description of the geometry suggests to start with a box
<span class="math notranslate nohighlight">\(\hat U=[26,35]\times[-10,5]\times[-500000,0]\)</span> (measured in degrees,
degrees, and meters) and to provide a map <span class="math notranslate nohighlight">\(\varphi\)</span> so
that <span class="math notranslate nohighlight">\(\varphi^{-1}(\hat U)=\Omega\)</span> where <span class="math notranslate nohighlight">\(\Omega\)</span> is the domain we
seek. <span class="math notranslate nohighlight">\((\Omega,\varphi)\)</span> is then a chart, <span class="math notranslate nohighlight">\(\varphi\)</span> the pull-back operator, and
<span class="math notranslate nohighlight">\(\varphi^{-1}\)</span> the push-forward operator. If we need a point <span class="math notranslate nohighlight">\(q\)</span> that is the
“average” of other points <span class="math notranslate nohighlight">\(q_i\in\Omega\)</span>, the <a class="reference external" href="https://www.dealii.org/current/doxygen/deal.II/classChartManifold.html">ChartManifold</a> class then first
applies the pull-back to obtain <span class="math notranslate nohighlight">\(\hat q_i=\varphi(q_i)\)</span>, averages these to a
point <span class="math notranslate nohighlight">\(\hat p\)</span> and then computes <span class="math notranslate nohighlight">\(p=\varphi^{-1}(\hat p)\)</span>.</p>
<p>Our goal here is therefore to implement a class that describes <span class="math notranslate nohighlight">\(\varphi\)</span> and
<span class="math notranslate nohighlight">\(\varphi^{-1}\)</span>. If Earth was a sphere, then this would not be difficult: if we
denote by <span class="math notranslate nohighlight">\((\hat \phi,\hat \theta,\hat d)\)</span> the points of <span class="math notranslate nohighlight">\(\hat U\)</span> (i.e.,
longitude counted eastward, latitude counted northward, and elevation relative
to zero depth), then $<span class="math notranslate nohighlight">\(\mathbf x = \varphi^{-1}(\hat \phi,\hat \theta,\hat d)
  = (R+\hat d) (\cos\hat \phi\cos\hat \theta, \sin\hat \phi\cos\hat \theta, \sin\hat \theta)^T\)</span><span class="math notranslate nohighlight">\( provides coordinates in a Cartesian coordinate system, where \)</span>R$ is the radius
of the sphere. However, the Earth is not a sphere:</p>
<ol class="arabic simple">
<li><p>It is flattened at the poles and larger at the equator: the semi-major axis is approximately 22km longer than the semi-minor axis. We will account for this using the <a class="reference external" href="http://en.wikipedia.org/wiki/WGS84">WGS84</a> reference standard for the Earth shape. The formula used in WGS 84 to obtain a position in Cartesian coordinates from longitude, latitude, and elevation is $<span class="math notranslate nohighlight">\(\mathbf x = \varphi_\text{WGS84}^{-1}(\phi,\theta,d)
= \left(
 \begin{array}{c}
  (\bar R(\theta)+d) \cos\phi\cos\theta, \\
  (\bar R(\theta)+d) \sin\phi\cos\theta, \\
  ((1-e^2)\bar R(\theta)+d) \sin\theta
 \end{array}
 \right),\)</span><span class="math notranslate nohighlight">\( where \)</span>\bar R(\theta)=\frac{R}{\sqrt{1-(e \sin\theta)^2}}<span class="math notranslate nohighlight">\(, and radius and ellipticity are given by \)</span>R=6378137\text{m}, e=0.081819190842622$. In this formula, we assume that the arguments to sines and cosines are evaluated in degree, not radians (though we will have to change this assumption in the code).</p></li>
<li><p>It has topography in the form of mountains and valleys. We will account for this using real topography data (see below for a description of where this data comes from). Using this data set, we can look up elevations on a latitude-longitude mesh laid over the surface of the Earth. Starting with the box <span class="math notranslate nohighlight">\(\hat U=[26,35]\times[-10,5]\times[-500000,0]\)</span>, we will therefore first stretch it in vertical direction before handing it off to the WGS 84 function: if <span class="math notranslate nohighlight">\(h(\hat\phi,\hat\theta)\)</span> is the height at longitude <span class="math notranslate nohighlight">\(\hat\phi\)</span> and latitude <span class="math notranslate nohighlight">\(\hat\theta\)</span>, then we define $<span class="math notranslate nohighlight">\((\phi,\theta,d) = \varphi_\text{topo}^{-1}(\hat\phi,\hat\theta,\hat d)
= \left(
   \hat\phi,
   \hat\theta,
   \hat d + \frac{\hat d+500000}{500000}h(\hat\phi,\hat\theta)
 \right).\)</span><span class="math notranslate nohighlight">\( Using this function, the top surface of the box \)</span>\hat U$ is displaced to the correct topography, the bottom surface remains where it was, and points in between are linearly interpolated.</p></li>
</ol>
</section>
<section id="implementation">
<h3>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">#</a></h3>
<p>There are a number of issues we need to address in the program. At the largest scale,
we need to write a class that implements the interface of <a class="reference external" href="https://www.dealii.org/current/doxygen/deal.II/classFunctionManifold.html">FunctionManifold</a> by using the corresponding Python wrapper. This involves
a function <code>push_forward()</code> that takes a point
in the reference domain <span class="math notranslate nohighlight">\(\hat U\)</span> and transform it into real space using the function
<span class="math notranslate nohighlight">\(\varphi^{-1}\)</span> outlined above, and its inverse function <code>pull_back()</code>
implementing <span class="math notranslate nohighlight">\(\varphi\)</span>.</p>
<p>The transformations we need have two parts: the WGS 84 transformations and the topography
transformation. Consequently, we will implement functions
<code>push_forward_wgs84()</code> and
<code>push_forward_topo()</code> that implement these two pieces, and
corresponding pull back functions.</p>
<p>The WGS 84 transformation functions are not particularly interesting (even though the
formulas they implement are impressive). The more interesting part is the topography
transformation. Recall that for this, we needed to evaluate the elevation function
<span class="math notranslate nohighlight">\(h(\hat\phi,\hat\theta)\)</span>. There is of course no formula for this: Earth is what it is,
the best one can do is look up the altitude from some table. This is, in fact what we
will do.</p>
<p>The data we use was originally created by the  <a
href="http://en.wikipedia.org/wiki/Shuttle_Radar_Topography_Mission">Shuttle
Radar Topography Mission</a>, was downloaded from the US Geologic Survey
(USGS) and processed by D. Sarah Stamps who also wrote the initial version of
the WGS 84 transformation functions. The topography data so processed is
stored in a file <code>topography.txt.gz</code> that, when unpacked
looks like this:</p>
<p>6.983333 25.000000 700<br>
6.983333 25.016667 692<br>
6.983333 25.033333 701<br>
6.983333 25.050000 695<br>
6.983333 25.066667 710<br>
6.983333 25.083333 702<br>
…<br>
-11.983333 35.950000 707<br>
-11.983333 35.966667 687<br>
-11.983333 35.983333 659<br></p>
<p>The data is formatted as <code>latitude longitude elevation</code> where the first two
columns are provided in degrees North of the equator and degrees East of the Greenwich
meridian. The final column is given in meters above the WGS 84 zero elevation.</p>
<p>In the transformation functions, we need to evaluate <span class="math notranslate nohighlight">\(h(\hat\phi,\hat\theta)\)</span> for a given
longitude <span class="math notranslate nohighlight">\(\hat\phi\)</span> and latitude <span class="math notranslate nohighlight">\(\hat\theta\)</span>. In general, this data point will not be
available and we will have to interpolate between adjacent data points. Fortunately,
widely available scipy library has the functionality for this.</p>
<p>Having discussed the general outline of how we want to implement things, let us go
to the program and show how it is done in practice.</p>
</section>
</section>
<section id="the-commented-program">
<h2>The commented program<a class="headerlink" href="#the-commented-program" title="Permalink to this heading">#</a></h2>
<section id="describing-topography">
<h3>Describing topography<a class="headerlink" href="#describing-topography" title="Permalink to this heading">#</a></h3>
<p>First, we read in our topography data from the file:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">topo_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;topography.txt.gz&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">topo_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[  6.983333  25.       700.      ]
 [  6.983333  25.05     695.      ]
 [  6.983333  25.1      697.      ]
 ...
 [-11.966667  35.85     722.      ]
 [-11.966667  35.9      738.      ]
 [-11.966667  35.95     693.      ]]
</pre></div>
</div>
</div>
</div>
<p>Now, create a 2-D interpolation object that would allow us to retrieve a topography value at an arbitrary location within the area. Since we have data on a regular grid with the known size, it is most efficient to use gridded 2-D interpolation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">RegularGridInterpolator</span>

<span class="n">lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">topo_data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]),</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">topo_data</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]),</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">220</span><span class="p">)</span>
<span class="n">lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">topo_data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">topo_data</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">380</span><span class="p">)</span>
<span class="n">altitude</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">topo_data</span><span class="p">[:,</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="mi">380</span><span class="p">,</span> <span class="mi">220</span><span class="p">))</span>

<span class="n">topo_function</span> <span class="o">=</span> <span class="n">RegularGridInterpolator</span><span class="p">((</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">),</span> <span class="n">altitude</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Let us also plot the data to make sure it looks right:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">altitude</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;terrain&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Latitude&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.colorbar.Colorbar at 0x7f91ba9421d0&gt;
</pre></div>
</div>
<img alt="_images/f5b87aeb15d44ac4366e1c97893ec9c7cfc3f3d83673137b428f2ab44b37338b.png" src="_images/f5b87aeb15d44ac4366e1c97893ec9c7cfc3f3d83673137b428f2ab44b37338b.png" />
</div>
</div>
</section>
<section id="describing-the-geometry">
<h3>Describing the geometry<a class="headerlink" href="#describing-the-geometry" title="Permalink to this heading">#</a></h3>
<p>This section describe transformation functions that we will need to construct our manifold.</p>
<p>The following two functions then define the forward and inverse
transformations that correspond to the WGS 84 reference shape of
Earth. The forward transform follows the formula shown in the
introduction. The inverse transform is significantly more complicated
and is, at the very least, not intuitive. It also suffers from the
fact that it returns an angle that at the end of the function we
need to clip back into the interval <span class="math notranslate nohighlight">\([0,2\pi]\)</span> if it should have
escaped from there.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">R</span>           <span class="o">=</span> <span class="mi">6378137</span>
<span class="n">ellipticity</span> <span class="o">=</span> <span class="mf">8.1819190842622e-2</span>
<span class="n">r2d</span> <span class="o">=</span> <span class="mf">180.</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>
<span class="n">d2r</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.</span>

<span class="k">def</span> <span class="nf">push_forward_wgs84</span><span class="p">(</span><span class="n">phi_theta_d</span><span class="p">):</span>
    <span class="n">phi</span>   <span class="o">=</span> <span class="n">phi_theta_d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">phi_theta_d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">d</span>     <span class="o">=</span> <span class="n">phi_theta_d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">R_bar</span> <span class="o">=</span> <span class="n">R</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="p">(</span><span class="n">ellipticity</span><span class="o">**</span><span class="mf">2.</span> <span class="o">*</span>
                                <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)))</span>

    <span class="k">return</span> <span class="p">[(</span><span class="n">R_bar</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
            <span class="p">(</span><span class="n">R_bar</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
            <span class="p">((</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">ellipticity</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">R_bar</span> <span class="o">+</span> <span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)]</span>

<span class="k">def</span> <span class="nf">pull_back_wgs84</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">b</span>   <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">R</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ellipticity</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">ep</span>  <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">R</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">p</span>   <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">th</span>  <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">R</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">b</span> <span class="o">*</span> <span class="n">p</span><span class="p">)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">ep</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">b</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">th</span><span class="p">),</span> <span class="mf">3.</span><span class="p">),</span>
                 <span class="p">(</span><span class="n">p</span> <span class="o">-</span>
                  <span class="p">(</span><span class="n">ellipticity</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">R</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pow</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">th</span><span class="p">),</span> <span class="mi">3</span><span class="p">))))</span>
    <span class="n">R_bar</span> <span class="o">=</span> <span class="n">R</span> <span class="o">/</span> <span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ellipticity</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span>
                           <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)))</span>
    <span class="n">R_plus_d</span> <span class="o">=</span> <span class="n">p</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>

    <span class="n">phi_theta_d</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">phi</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">phi_theta_d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">elif</span> <span class="n">phi</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
        <span class="n">phi_theta_d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">phi_theta_d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi</span>
    <span class="n">phi_theta_d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span>
    <span class="n">phi_theta_d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">R_plus_d</span> <span class="o">-</span> <span class="n">R_bar</span>
    
    <span class="k">return</span> <span class="n">phi_theta_d</span>
</pre></div>
</div>
</div>
</div>
<p>Next, the topography transformations follow exactly the description in the introduction. The only thing to note here is that we invoke the interpolant for the input topography data that we constructed above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">push_forward_topo</span><span class="p">(</span><span class="n">phi_theta_d_hat</span><span class="p">):</span>
    <span class="n">d_hat</span> <span class="o">=</span> <span class="n">phi_theta_d_hat</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">topo_function</span><span class="p">((</span><span class="n">phi_theta_d_hat</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">r2d</span><span class="p">,</span> <span class="n">phi_theta_d_hat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">r2d</span><span class="p">))</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">d_hat</span> <span class="o">+</span> <span class="p">(</span><span class="n">d_hat</span> <span class="o">+</span> <span class="mf">500000.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">500000.</span> <span class="o">*</span> <span class="n">h</span>
    
    <span class="k">return</span> <span class="p">[</span><span class="n">phi_theta_d_hat</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phi_theta_d_hat</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">d</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">pull_back_topo</span><span class="p">(</span><span class="n">phi_theta_d</span><span class="p">):</span>
    <span class="n">d</span>     <span class="o">=</span> <span class="n">phi_theta_d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">h</span>     <span class="o">=</span> <span class="n">topo_function</span><span class="p">((</span><span class="n">phi_theta_d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">r2d</span><span class="p">,</span> <span class="n">phi_theta_d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">r2d</span><span class="p">))</span>
    <span class="n">d_hat</span> <span class="o">=</span> <span class="mf">500000.</span> <span class="o">*</span> <span class="p">(</span><span class="n">d</span> <span class="o">-</span> <span class="n">h</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">500000.</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">[</span><span class="n">phi_theta_d</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">phi_theta_d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">d_hat</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, both of the pull back and push forward functions are just concatenations of the respective functions of the WGS 84 and topography mappings:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">pull_back</span><span class="p">(</span><span class="n">space_point</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pull_back_topo</span><span class="p">(</span><span class="n">pull_back_wgs84</span><span class="p">(</span><span class="n">space_point</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">push_forward</span><span class="p">(</span><span class="n">chart_point</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">push_forward_wgs84</span><span class="p">(</span><span class="n">push_forward_topo</span><span class="p">(</span><span class="n">chart_point</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Now we are ready to construct a FunctionManifold object with the defined transformations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">geometry</span> <span class="o">=</span> <span class="n">dealii</span><span class="o">.</span><span class="n">Manifold</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">spacedim</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">geometry</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span><span class="n">push_forward</span><span class="p">,</span> <span class="n">pull_back</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="creating-the-mesh">
<h3>Creating the mesh<a class="headerlink" href="#creating-the-mesh" title="Permalink to this heading">#</a></h3>
<p>Having so described the properties of the geometry, not it is
time to deal with the mesh used to discretize it. To this end,
we create objects for the geometry and triangulation, and then
proceed to create a <span class="math notranslate nohighlight">\(1\times 2\times 1\)</span> rectangular mesh that
corresponds to the reference domain
<span class="math notranslate nohighlight">\(\hat U=[26,35]\times[-10,5]\times[-500000,0]\)</span>. We choose
this number of subdivisions because it leads to cells that
are roughly like cubes instead of stretched in one direction or
another.</p>
<p>Of course, we are not actually interested in meshing the
reference domain. We are interested in meshing the real domain.
Consequently, we will use the GridTools::transform() function
that simply moves every point of a triangulation according to
a given transformation. The transformation function it wants is
a function that takes as its single argument a point in the reference
domain and returns the corresponding location in the domain that we
want to map to. This is, of course, exactly the push forward
function of the geometry we use.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">repetitions</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">dealii</span><span class="o">.</span><span class="n">Point</span><span class="p">([</span><span class="mi">26</span> <span class="o">*</span> <span class="n">d2r</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span> <span class="o">*</span> <span class="n">d2r</span><span class="p">,</span> <span class="o">-</span><span class="mi">500000</span><span class="p">])</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">dealii</span><span class="o">.</span><span class="n">Point</span><span class="p">([</span><span class="mi">35</span> <span class="o">*</span> <span class="n">d2r</span><span class="p">,</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">d2r</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>

<span class="n">triangulation</span> <span class="o">=</span> <span class="n">dealii</span><span class="o">.</span><span class="n">Triangulation</span><span class="p">(</span><span class="s1">&#39;3D&#39;</span><span class="p">)</span>
<span class="n">triangulation</span><span class="o">.</span><span class="n">generate_subdivided_hyper_rectangle</span><span class="p">(</span><span class="n">repetitions</span><span class="p">,</span>\
                                                  <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">colorize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">triangulation</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">push_forward</span><span class="p">)</span>

<span class="n">manifold_id</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">triangulation</span><span class="o">.</span><span class="n">set_manifold</span><span class="p">(</span><span class="n">number</span> <span class="o">=</span> <span class="n">manifold_id</span><span class="p">,</span> <span class="n">manifold</span> <span class="o">=</span> <span class="n">geometry</span><span class="p">)</span>
<span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">triangulation</span><span class="o">.</span><span class="n">active_cells</span><span class="p">():</span>
    <span class="n">cell</span><span class="o">.</span><span class="n">set_all_manifold_ids</span><span class="p">(</span><span class="n">manifold_id</span><span class="p">)</span>        
</pre></div>
</div>
</div>
</div>
<p>The last step is to refine the mesh beyond its initial <span class="math notranslate nohighlight">\(1\times 2\times
  1\)</span> coarse mesh. We could just refine globally a number of times, but
since for the purpose of this tutorial program we’re really only
interested in what is happening close to the surface, we just refine 6
times all of the cells that have a face at a boundary with indicator 5.
Looking this up in the documentation of the
GridGenerator::subdivided_hyper_rectangle() function we have used above
reveals that boundary indicator 5 corresponds to the top surface of the
domain (and this is what the last <code>True</code> argument in the call
to <em>generate_subdivided_hyper_rectangle()</em> above meant: to “color”
the boundaries by assigning each boundary a unique boundary indicator).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">triangulation</span><span class="o">.</span><span class="n">active_cells</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">cell</span><span class="o">.</span><span class="n">faces</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">face</span><span class="o">.</span><span class="n">at_boundary</span><span class="p">()</span> <span class="ow">and</span> <span class="n">face</span><span class="o">.</span><span class="n">boundary_id</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                <span class="n">cell</span><span class="o">.</span><span class="n">refine_flag</span> <span class="o">=</span><span class="s1">&#39;isotropic&#39;</span>
                
    <span class="n">triangulation</span><span class="o">.</span><span class="n">execute_coarsening_and_refinement</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Let us now print some statistics about our mesh:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fmt_str</span> <span class="o">=</span> <span class="s1">&#39;# of cells = </span><span class="si">%d</span><span class="se">\n</span><span class="s1">smallest cell = </span><span class="si">%0.1f</span><span class="s1"> m</span><span class="se">\n</span><span class="s1">largest cell = </span><span class="si">%0.1f</span><span class="s1"> m&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">fmt_str</span> <span class="o">%</span> <span class="p">(</span><span class="n">triangulation</span><span class="o">.</span><span class="n">n_active_cells</span><span class="p">(),</span>\
                 <span class="n">triangulation</span><span class="o">.</span><span class="n">minimal_cell_diameter</span><span class="p">(),</span>\
                 <span class="n">triangulation</span><span class="o">.</span><span class="n">maximal_cell_diameter</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span># of cells = 19112
smallest cell = 21579.0 m
largest cell = 660950.0 m
</pre></div>
</div>
</div>
</div>
<p>We can finally save the mesh:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">triangulation</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;mesh.vtu&#39;</span><span class="p">,</span> <span class="s1">&#39;vtu&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This gives us the following mesh (here coloured by the element volume):</p>
<p><img alt="Image" src="https://www.dealii.org/images/steps/developer/step-53.mesh.png" /></p>
<p>For more details about visualization and discussion of results with underlying issues the reader is referred to the section <a class="reference external" href="https://www.dealii.org/current/doxygen/deal.II/step_53.html">Results</a> of the original tutorial program.</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="step-49.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Step-49</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#python-initialization">Python initialization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#where-geometry-and-meshes-intersect">Where geometry and meshes intersect</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#the-example-case">The example case</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-commented-program">The commented program</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#describing-topography">Describing topography</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#describing-the-geometry">Describing the geometry</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-the-mesh">Creating the mesh</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By The Jupyter Book Community
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=5b4479735964841361fd"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=5b4479735964841361fd"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>